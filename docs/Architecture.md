# System Architecture

Canonical reference for the scope3-execution platform.
Defines components, principles, and constraints.

---

## Components

### Backend

FastAPI monolith in `backend/server.py` (~3970 lines). All routes use the `/api` prefix.

| Concern | Implementation |
|---|---|
| Database | Motor async MongoDB driver |
| Auth | Session-based, `session_token` httpOnly cookie, SameSite adaptive (Lax in production, None on localhost) |
| PDF storage | Fernet-encrypted files on disk |
| AI / OCR | Gemini 2.0 Flash via `google-genai` SDK for recommendations and document OCR |
| Rate limiting | Mongo TTL collection (`rate_limit_hits`), per-IP sliding window |
| Audit trail | `audit_events` collection; every critical state change is logged |
| Frontend serving | `SERVE_FRONTEND_DIR` env var mounts the built CRA bundle at the same origin via `StaticFiles` |

### Frontend

Create React App (Craco) + Tailwind CSS + Radix UI primitives.

- **Pages** (7 modules): `src/pages/Dashboard.jsx`, `LandingPage.jsx`, `MeasurePage.jsx`, `ReduceDashboard.jsx`, `EngagePage.jsx`, `EvidencePage.jsx`, `QualityPage.jsx`
- **Shared components**: `src/components/` (Sidebar, DeepDivePanel, PageBboxOverlay, integrations/)
- **API helper**: `src/lib/api.js` exports `apiUrl()` for backend URL resolution (same-origin in production, `localhost:8000` in dev)
- **Theme**: Dark background `#0A0A0A`, green accents `#22C55E`

### Database

MongoDB. No Postgres, no Redis.

**Core collections:**

| Group | Collections |
|---|---|
| Supply chain | `supplier_benchmarks`, `recommendation_content`, `emission_factors`, `purchases`, `activities` |
| Evidence | `disclosure_sources`, `disclosure_docs`, `ocr_blocks`, `field_provenance` |
| Quality | `anomalies` |
| Engagement | `engagements`, `integration_states` |
| Measurement | `measure_input_rows` |
| Platform | `user_sessions`, `audit_events`, `rate_limit_hits` |

### Deployment

Single Render web service.

```
Build:  pip install -r requirements.txt && cd frontend && npm ci && npm run build
Start:  uvicorn backend.server:app --host 0.0.0.0 --port $PORT
```

`SERVE_FRONTEND_DIR=frontend/build` serves the SPA from the same origin. No separate frontend deploy.

---

## Architecture Principles

1. **Evidence-first** -- Every numeric claim links to document, page, bounding box, and field. No number exists without provenance.

2. **Deterministic numerics** -- No `float` for money. Stable sort with tie-breakers. No `NaN`/`Inf` in JSON output. Use `Decimal.quantize` for rounding.

3. **LLM-free quality** -- Quality anomaly checks are deterministic code, not LLM calls. Results are reproducible across runs.

4. **Async-first** -- All DB operations use Motor async. No blocking IO in request handlers.

5. **Monolith-first** -- Single `server.py` for the backend. Extract to `backend/services/`, `backend/routes/`, `backend/schemas/` only when complexity warrants it.

6. **Cookie-based auth** -- `session_token` httpOnly cookie. `SameSite=Lax` in production, `SameSite=None; Secure` on localhost with HTTPS proxy.

---

## Constraints

- **MongoDB only.** No Postgres, no Redis, no external cache.
- **Single Python file** for the backend. Refactor path is `backend/services/`, `backend/routes/`, `backend/schemas/` but has not been executed.
- **CRA, not Next.js.** Client-side routing only. No SSR, no server components.
- **Mock integrations.** All 17 connectors (Slack, Jira, SAP, etc.) are demo/mock implementations. No real API calls.
- **Auth is emergent.** Production OAuth (Google/Microsoft) is a dependency that has not been wired yet. Current auth is session-cookie with plaintext password check.

---

## Data Flow

```
Sources --> Download --> Ingest/Chunk --> Generate Recommendations
    |                                           |
    v                                           v
  Evidence (PDF --> OCR --> Provenance)    Reduce Dashboard
    |                                           |
    v                                           v
  Quality (anomaly scan)                  Engage (outreach)
    |                                           |
    v                                           v
  Report (audit-ready aggregation)
```

**Evidence pipeline:** PDF upload --> Fernet encrypt to disk --> OCR via Gemini --> `ocr_blocks` per page --> `field_provenance` links extracted values to bounding boxes --> `anomalies` generated by deterministic checks.

**Recommendation pipeline:** `emission_factors` + `purchases` + `activities` --> Gemini generates `recommendation_content` --> `supplier_benchmarks` for ranking --> Reduce Dashboard renders ranked actions.

**Engagement pipeline:** Recommendations feed into `engagements` --> outreach tracking --> `integration_states` for mock connector status.

---

## Key Environment Variables

| Variable | Purpose |
|---|---|
| `MONGODB_URI` | MongoDB connection string |
| `SESSION_SECRET` | Secret for session token signing |
| `FERNET_KEY` | Encryption key for PDF storage |
| `GOOGLE_API_KEY` | Gemini API access |
| `SERVE_FRONTEND_DIR` | Path to built frontend (e.g., `frontend/build`) |
| `PORT` | Uvicorn listen port (set by Render) |
